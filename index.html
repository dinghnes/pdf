<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF å…¨èƒ½å·¥å…·ç®± (å«æ™ºèƒ½å£“ç¸®)</title>
    <!-- 1. æ ¸å¿ƒå¼•æ“ï¼špdf-lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <!-- 2. å£“ç¸®å·¥å…·ï¼šJSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 3. æ¸²æŸ“å¼•æ“ï¼špdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // è¨­å®š pdf.js worker
        window.onload = function() {
            if (window.pdfjsLib) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            initDragAndDrop();
        };
    </script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 900px;
        }

        h1 { color: #333; margin-bottom: 1rem; }

        /* åˆ†é æ¨™ç±¤æ¨£å¼ */
        .tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            font-size: 0.95rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: white;
            background-color: #007bff;
        }

        .tab-btn:hover:not(.active) { color: #555; background-color: #f0f0f0; }

        /* é€šç”¨æ¨£å¼ */
        .input-group {
            margin-bottom: 1.5rem;
            text-align: center;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            transition: all 0.3s;
            position: relative;
        }

        .input-group:hover { border-color: #007bff; }

        .input-group.drag-over {
            border-color: #007bff;
            background-color: #f1f8ff;
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }

        input[type="file"] { display: none; }

        .custom-file-label {
            cursor: pointer;
            color: #007bff;
            font-weight: bold;
            display: block;
            pointer-events: none;
        }
        
        .custom-file-label span {
            pointer-events: none;
        }
        
        .settings-group {
            margin: 15px 0;
            text-align: left;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            display: grid;
            gap: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .setting-item label {
            font-weight: bold;
            color: #555;
            margin-right: 10px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .setting-item select, .setting-item input[type="text"], .setting-item input[type="number"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
        }

        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button.action-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        button.action-btn:hover { background-color: #0056b3; }
        button.action-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* é è¦½å€ (Grid) */
        .grid-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            min-height: 50px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        .preview-item {
            position: relative;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .preview-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .preview-item.dragging { opacity: 0.5; border: 2px dashed #007bff; }
        
        .preview-item img { 
            width: 100%; 
            height: 140px; 
            object-fit: contain; 
            border-radius: 4px; 
            background-color: #f0f0f0;
            pointer-events: none; 
        }
        
        .preview-item .pdf-icon {
            width: 100%; height: 140px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background-color: #fce4ec; color: #d32f2f; border-radius: 4px; font-weight: bold;
        }
        
        .preview-item .file-name {
            font-size: 10px; color: #666; margin-top: 4px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; text-align: center;
        }

        .remove-btn {
            position: absolute; top: -5px; right: -5px;
            background: #ff4d4d; color: white; border: none; border-radius: 50%;
            width: 24px; height: 24px; line-height: 24px; text-align: center;
            cursor: pointer; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2;
        }

        .page-badge { 
            font-size: 12px; 
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 5px;
            color: #333; 
        }

        .status-msg { margin-top: 1rem; font-size: 0.9rem; color: #666; }

        .view-section { display: none; }
        .view-section.active { display: block; }
        
        .selected-file-name {
            color: #28a745;
            font-weight: bold;
            margin-bottom: 10px;
            display: none;
        }

        .split-hint {
            background-color: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: left;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>PDF å…¨èƒ½å·¥å…·ç®±</h1>
    
    <!-- åˆ†é åˆ‡æ› -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('merge')">1. åˆä½µ</button>
        <button class="tab-btn" onclick="switchTab('split')">2. æ‹†åˆ†</button>
        <button class="tab-btn" onclick="switchTab('img-split')">3. åˆ†å‰²åœ–ç‰‡</button>
        <button class="tab-btn" onclick="switchTab('convert')">4. è½‰åœ–ç‰‡</button>
        <button class="tab-btn" onclick="switchTab('compress')">5. æ™ºèƒ½å£“ç¸® (æŒ‡å®šå¤§å°)</button>
    </div>

    <!-- ================= 1. åˆä½µæ¨¡å¼ ================= -->
    <div id="merge-view" class="view-section active">
        <div class="input-group" id="merge-input-group">
            <label for="mergeInput" class="custom-file-label">
                ğŸ“‚ é¸æ“‡æˆ–æ‹–æ›³åœ–ç‰‡/PDF<br>
                <span>(æ”¯æ´å¤šæª”æ··åˆåˆä½µã€æ‹–æ›³æ’åº)</span>
            </label>
            <input type="file" id="mergeInput" accept="image/*, .pdf" multiple onchange="handleMergeFiles(this.files)">
        </div>

        <div class="settings-group">
            <div class="setting-item">
                <label for="pageSize">ğŸ“„ é é¢å¤§å°ï¼š</label>
                <select id="pageSize">
                    <option value="original">ä¾ç…§åŸåœ–</option>
                    <option value="a4">A4 æ¨™æº–ç´™å¼µ</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="quality">ğŸ—œï¸ å£“ç¸®å“è³ªï¼š</label>
                <select id="quality">
                    <option value="0.95">é«˜ç•«è³ª</option>
                    <option value="0.75">æ¨™æº–</option>
                    <option value="0.5">é«˜å£“ç¸®</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="showPageNumbers">ğŸ”¢ é¡¯ç¤ºé ç¢¼ï¼š</label>
                <input type="checkbox" id="showPageNumbers">
            </div>
        </div>

        <div id="merge-preview-area" class="grid-area"></div>
        <button id="convertBtn" class="action-btn" onclick="generateMergedPDF()">é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰</button>
        <div id="merge-status" class="status-msg"></div>
    </div>

    <!-- ================= 2. æ‹†åˆ†æ¨¡å¼ ================= -->
    <div id="split-view" class="view-section">
        <div class="input-group" id="split-input-group">
            <label for="splitInput" class="custom-file-label">
                âœ‚ï¸ é¸æ“‡å–®å€‹ PDF<br>
                <span>(å¯è‡ªç”±åˆªé™¤é é¢)</span>
            </label>
            <input type="file" id="splitInput" accept=".pdf" onchange="handleSplitFileVisual(this.files)">
        </div>
        
        <div id="split-file-name" class="selected-file-name"></div>

        <div id="split-editor-container" style="display: none;">
            <div class="split-hint">é»æ“Š <strong>ç´…è‰² X</strong> åˆªé™¤ä¸è¦çš„é é¢ã€‚</div>
            <div id="split-visual-area" class="grid-area"></div>
            <div class="settings-group">
                <div class="setting-item">
                    <label for="splitOutputMode">ğŸ’¾ åŒ¯å‡ºæ–¹å¼ï¼š</label>
                    <select id="splitOutputMode">
                        <option value="merge_remaining">å„²å­˜ç‚ºå–®ä¸€ PDF</option>
                        <option value="split_remaining">æ‹†åˆ†ç‚ºå¤šå€‹ PDF</option>
                    </select>
                </div>
            </div>
            <button id="splitBtn" class="action-btn" onclick="executeSplitVisual()">åŸ·è¡ŒåŒ¯å‡º</button>
            <button class="action-btn" style="background-color: #6c757d; margin-top: 10px;" onclick="resetSplitView()">é‡é¸</button>
        </div>
        <div id="split-status" class="status-msg"></div>
    </div>

    <!-- ================= 3. åœ–ç‰‡åˆ†å‰²æ¨¡å¼ ================= -->
    <div id="img-split-view" class="view-section">
        <div class="input-group" id="img-split-input-group">
            <label for="imgSplitInput" class="custom-file-label">
                ğŸ“– é¸æ“‡åœ–ç‰‡ (JPG/PNG)<br>
                <span>(ä¸€å¼µåœ–åˆ‡æˆå…©é  A4)</span>
            </label>
            <input type="file" id="imgSplitInput" accept="image/*" multiple onchange="handleImgSplitFiles(this.files)">
        </div>
        <div id="img-split-preview-area" class="grid-area"></div>
        <div class="settings-group">
            <div class="setting-item">
                <label for="splitDirection">é–±è®€æ–¹å‘ï¼š</label>
                <select id="splitDirection">
                    <option value="ltr">å·¦ç¿» (å·¦1 å³2)</option>
                    <option value="rtl">å³ç¿» (å³1 å·¦2)</option>
                </select>
            </div>
        </div>
        <button id="imgSplitBtn" class="action-btn" onclick="executeImageSplit()">åˆ†å‰²ä¸¦è½‰ PDF</button>
        <div id="img-split-status" class="status-msg"></div>
    </div>

    <!-- ================= 4. è½‰åœ–ç‰‡æ¨¡å¼ ================= -->
    <div id="convert-view" class="view-section">
        <div class="input-group" id="convert-input-group">
            <label for="convertInput" class="custom-file-label">
                ğŸ–¼ï¸ é¸æ“‡å–®å€‹ PDF<br>
                <span>(PDF è½‰ JPG/PNG)</span>
            </label>
            <input type="file" id="convertInput" accept=".pdf" onchange="handleConvertFile(this.files)">
        </div>
        <div id="convert-file-name" class="selected-file-name"></div>
        <div class="settings-group">
            <div class="setting-item">
                <label for="outputFormat">è¼¸å‡ºæ ¼å¼ï¼š</label>
                <select id="outputFormat">
                    <option value="jpeg">JPG</option>
                    <option value="png">PNG</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="renderScale">è§£æåº¦ï¼š</label>
                <select id="renderScale">
                    <option value="1">æ¨™æº–</option>
                    <option value="2" selected>é«˜ç•«è³ª (æ¨è–¦)</option>
                    <option value="3">è¶…é«˜ç•«è³ª</option>
                </select>
            </div>
        </div>
        <button id="toImageBtn" class="action-btn" onclick="executePdfToImage()">è½‰åœ–ä¸¦ä¸‹è¼‰</button>
        <div id="convert-status" class="status-msg"></div>
    </div>

    <!-- ================= 5. æ™ºèƒ½å£“ç¸®æ¨¡å¼ (Smart Compress) - NEW ================= -->
    <div id="compress-view" class="view-section">
        <div class="input-group" id="compress-input-group">
            <label for="compressInput" class="custom-file-label">
                ğŸ—œï¸ é¸æ“‡ PDF æˆ– åœ–ç‰‡<br>
                <span>(è‡ªå‹•å£“åˆ°æŒ‡å®šå¤§å°ä»¥ä¸‹)</span>
            </label>
            <input type="file" id="compressInput" accept="image/*, .pdf" multiple onchange="handleCompressFiles(this.files)">
        </div>

        <div id="compress-file-list" class="grid-area" style="min-height: 50px; max-height: 200px;"></div>

        <div class="settings-group">
            <div class="setting-item">
                <label for="targetSizeMB" style="color: #d32f2f;">ğŸ¯ ç›®æ¨™å¤§å° (MB)ï¼š</label>
                <input type="number" id="targetSizeMB" value="5" min="0.1" step="0.1" style="font-weight: bold; color: #d32f2f;">
            </div>
            <div class="split-hint">
                âš ï¸ æ³¨æ„ï¼šæ­¤åŠŸèƒ½æœƒå°‡æ‰€æœ‰å…§å®¹é‡æ–°è½‰æ›ç‚ºåœ–ç‰‡å†åˆæˆ PDFã€‚è‹¥åŸæª”æ˜¯æ–‡å­—ç‰ˆ PDFï¼Œæ–‡å­—å°‡æœƒè®Šæˆåœ–ç‰‡(ç„¡æ³•é¸å–æ–‡å­—)ã€‚
            </div>
        </div>

        <button id="compressBtn" class="action-btn" onclick="executeSmartCompress()">é–‹å§‹æ™ºèƒ½å£“ç¸®</button>
        <div id="compress-status" class="status-msg"></div>
    </div>

</div>

<script>
    const PDFLib = window.PDFLib;
    const { PDFDocument, rgb, StandardFonts } = PDFLib || {};

    window.onload = function() {
        if (!window.PDFLib) alert("éŒ¯èª¤ï¼šPDF æ ¸å¿ƒåº«æœªè¼‰å…¥");
        if (window.pdfjsLib) window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        initDragAndDrop();
    };

    // --- Tab åˆ‡æ› ---
    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));
        
        const tabs = document.querySelectorAll('.tab-btn');
        const views = ['merge-view', 'split-view', 'img-split-view', 'convert-view', 'compress-view'];
        let idx = 0;
        if(mode === 'split') idx=1;
        if(mode === 'img-split') idx=2;
        if(mode === 'convert') idx=3;
        if(mode === 'compress') idx=4;

        tabs[idx].classList.add('active');
        document.getElementById(views[idx]).classList.add('active');
    }

    // --- æ‹–æ”¾åˆå§‹åŒ– ---
    function initDragAndDrop() {
        setupDragAndDrop('merge-input-group', handleMergeFiles);
        setupDragAndDrop('split-input-group', handleSplitFileVisual);
        setupDragAndDrop('img-split-input-group', handleImgSplitFiles);
        setupDragAndDrop('convert-input-group', handleConvertFile);
        setupDragAndDrop('compress-input-group', handleCompressFiles);
    }

    function setupDragAndDrop(areaId, handler) {
        const area = document.getElementById(areaId);
        if (!area) return;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => area.addEventListener(e, preventDefaults, false));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(e => area.addEventListener(e, () => area.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(e => area.addEventListener(e, () => area.classList.remove('drag-over'), false));
        area.addEventListener('drop', (e) => handler(e.dataTransfer.files), false);
        area.addEventListener('click', () => { const inp = area.querySelector('input'); if(inp) inp.click(); });
    }

    // ================= 1. åˆä½µé‚è¼¯ (ç°¡åŒ–) =================
    const mergePreviewArea = document.getElementById('merge-preview-area');
    function handleMergeFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => createPreviewItem(file, mergePreviewArea));
        document.getElementById('mergeInput').value = '';
    }
    // (createMergePreviewItem ç­‰é‚è¼¯å…±ç”¨ createPreviewItem)

    // ================= 5. æ™ºèƒ½å£“ç¸®é‚è¼¯ (Smart Compress) =================
    const compressFileList = document.getElementById('compress-file-list');
    function handleCompressFiles(files) {
        if(!files.length) return;
        Array.from(files).forEach(file => createPreviewItem(file, compressFileList));
        document.getElementById('compressInput').value = '';
    }

    async function executeSmartCompress() {
        const items = document.querySelectorAll('#compress-file-list .preview-item');
        const status = document.getElementById('compress-status');
        const btn = document.getElementById('compressBtn');
        const targetMB = parseFloat(document.getElementById('targetSizeMB').value);
        
        if (items.length === 0) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
        if (!targetMB || targetMB <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç›®æ¨™å¤§å°ï¼"); return; }

        const targetBytes = targetMB * 1024 * 1024;
        btn.disabled = true; btn.innerText = "åˆ†æä¸­...";
        
        try {
            // 1. æ”¶é›†æ‰€æœ‰é é¢ (åœ–ç‰‡æˆ– PDF é )
            let allPagesData = []; // { type: 'img', obj: Image } or similar
            
            for (let i = 0; i < items.length; i++) {
                const file = items[i].fileData;
                status.innerText = `æ­£åœ¨è®€å–æª”æ¡ˆ (${i+1}/${items.length}): ${file.name}...`;
                
                if (file.type === 'application/pdf') {
                    // Rasterize PDF
                    const buffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(buffer).promise;
                    for (let p = 1; p <= pdf.numPages; p++) {
                        const page = await pdf.getPage(p);
                        const viewport = page.getViewport({ scale: 1.5 }); // é è¨­ 1.5 å€æ¸…æ™°åº¦
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width; canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                        const img = await loadImage(canvas.toDataURL());
                        allPagesData.push(img);
                    }
                } else {
                    const dataUrl = await readFileAsDataURL(file);
                    const img = await loadImage(dataUrl);
                    allPagesData.push(img);
                }
            }

            status.innerText = `å…±æ”¶é›†åˆ° ${allPagesData.length} é ï¼Œé–‹å§‹æ™ºèƒ½å£“ç¸®...`;
            
            // 2. è¿­ä»£å£“ç¸®ç®—æ³•
            let quality = 0.8; // åˆå§‹å“è³ª
            let pdfBytes = null;
            let finalSize = 0;
            let attempts = 0;
            const maxAttempts = 4;
            
            while (attempts < maxAttempts) {
                attempts++;
                status.innerText = `å˜—è©¦å£“ç¸® (ç¬¬ ${attempts} æ¬¡) - å“è³ªåƒæ•¸: ${quality.toFixed(2)}...`;
                
                const pdfDoc = await PDFDocument.create();
                
                // ä¼°ç®— JPEG å¤§å°ç¸½å’Œ (ä¸ç”Ÿæˆå®Œæ•´ PDF ä»¥åŠ é€Ÿ)
                let totalJpegSize = 0;
                const jpegBuffers = [];

                for (const img of allPagesData) {
                    const { buffer } = await convertToJpegBuffer(img, quality);
                    totalJpegSize += buffer.byteLength;
                    jpegBuffers.push({ buffer, width: img.width, height: img.height });
                }

                // åŠ ä¸Š PDF overhead ä¼°ç®— (æ¯é ç´„ 1KB + åŸºç¤ 5KB)
                const estimatedSize = totalJpegSize + (jpegBuffers.length * 1024) + 5000;
                
                console.log(`Attempt ${attempts}: Q=${quality}, Est Size=${(estimatedSize/1024/1024).toFixed(2)}MB`);

                // å¦‚æœä¼°ç®—å¤§å°å·²ç¶“åˆæ ¼ï¼Œæˆ–è€…é€™æ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œå‰‡ç”Ÿæˆ PDF
                if (estimatedSize <= targetBytes || attempts === maxAttempts) {
                    for (const j of jpegBuffers) {
                        const imgEmbed = await pdfDoc.embedJpg(j.buffer);
                        const page = pdfDoc.addPage([j.width, j.height]);
                        page.drawImage(imgEmbed, { x: 0, y: 0, width: j.width, height: j.height });
                    }
                    pdfBytes = await pdfDoc.save();
                    finalSize = pdfBytes.byteLength;
                    
                    if (finalSize <= targetBytes) break; // æˆåŠŸ
                }

                // èª¿æ•´å“è³ªåƒæ•¸
                if (estimatedSize > targetBytes) {
                    // å¤ªå¤§ï¼Œé™ä½å“è³ª
                    const ratio = targetBytes / estimatedSize;
                    quality = quality * ratio * 0.9; // 0.9 æ˜¯å®‰å…¨ä¿‚æ•¸
                    if (quality < 0.1) quality = 0.1; // æœ€ä½å“è³ª
                } else {
                    // å·²ç¶“å¤ å°äº† (åœ¨ä¼°ç®—éšæ®µé€šé)ï¼Œç”¢ç”Ÿ PDF é€€å‡º
                    // ä¸Šé¢çš„ if å€å¡Šæœƒè™•ç†ç”Ÿæˆ
                }
            }

            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const finalMB = (finalSize / 1024 / 1024).toFixed(2);
            downloadBlob(blob, `compressed_target_${targetMB}MB.pdf`);
            
            if (finalSize > targetBytes) {
                status.innerText = `å·²ç›¡åŠ›å£“ç¸®ï¼æœ€çµ‚å¤§å°: ${finalMB} MB (å·²é”ç•«è³ªæ¥µé™)ã€‚`;
            } else {
                status.innerText = `æˆåŠŸï¼æœ€çµ‚å¤§å°: ${finalMB} MBã€‚`;
            }

        } catch (e) {
            console.error(e);
            alert("å£“ç¸®å¤±æ•—: " + e.message);
            status.innerText = "ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            btn.disabled = false; btn.innerText = "é–‹å§‹æ™ºèƒ½å£“ç¸®";
        }
    }

    // ================= é€šç”¨ UI å‡½å¼ =================
    function createPreviewItem(file, container) {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.draggable = true;
        div.fileData = file;

        if (file.type === 'application/pdf') {
            const icon = document.createElement('div');
            icon.className = 'pdf-icon';
            icon.innerHTML = '<span>PDF</span>';
            div.appendChild(icon);
        } else {
            const img = document.createElement('img');
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; };
            reader.readAsDataURL(file);
            div.appendChild(img);
        }

        const name = document.createElement('div');
        name.className = 'file-name';
        name.innerText = file.name;
        div.appendChild(name);

        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.innerHTML = 'Ã—';
        btn.onclick = function(e) { e.stopPropagation(); div.remove(); };
        div.appendChild(btn);

        // ç¶å®šæ’åºäº‹ä»¶ (åƒ…é‡å°åˆä½µèˆ‡å£“ç¸®å€)
        addSortEvents(div, container);
        container.appendChild(div);
    }

    let dragSrcEl = null;
    function addSortEvents(item, container) {
        item.addEventListener('dragstart', function(e) {
            this.classList.add('dragging'); dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
        });
        item.addEventListener('dragover', function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
        item.addEventListener('drop', function(e) {
            e.stopPropagation();
            if (dragSrcEl !== this) {
                const items = Array.from(container.children);
                if (items.indexOf(dragSrcEl) < items.indexOf(this)) this.after(dragSrcEl);
                else this.before(dragSrcEl);
            }
        });
        item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
    }

    // ================= æ‹†åˆ†/åœ–ç‰‡åˆ†å‰²/è½‰æª” é‚è¼¯ (ä¿ç•™åŸåŠŸèƒ½) =================
    // (ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œæ­¤è™•ä¿ç•™èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒçš„é—œéµé‚è¼¯ï¼Œä½†ç‚ºäº†ç¢ºä¿å®Œæ•´é‹è¡Œï¼Œä¸‹æ–¹æä¾›ç°¡åŒ–ç‰ˆçš„æ ¸å¿ƒåŠŸèƒ½å‡½å¼)

    async function generateMergedPDF() {
        const items = document.querySelectorAll('#merge-preview-area .preview-item');
        if (!items.length) { alert("è«‹é¸æ“‡æª”æ¡ˆ"); return; }
        const pdfDoc = await PDFDocument.create();
        const quality = parseFloat(document.getElementById('quality').value);
        // ... (åŒå‰ç‰ˆé‚è¼¯)
        // ç‚ºäº†ç¢ºä¿åŠŸèƒ½æ­£å¸¸ï¼Œé€™è£¡é‡è¤‡é—œéµä»£ç¢¼
        for (let i = 0; i < items.length; i++) {
            const file = items[i].fileData;
            if (file.type === 'application/pdf') {
                const srcPdf = await PDFDocument.load(await file.arrayBuffer());
                (await pdfDoc.copyPages(srcPdf, srcPdf.getPageIndices())).forEach(p => pdfDoc.addPage(p));
            } else {
                const img = await loadImage(await readFileAsDataURL(file));
                const { buffer, width, height } = await convertToJpegBuffer(img, quality);
                const imgEmbed = await pdfDoc.embedJpg(buffer);
                const mode = document.getElementById('pageSize').value;
                const page = pdfDoc.addPage(mode==='a4' ? [595.28, 841.89] : [width, height]);
                if(mode==='a4') {
                    const dims = imgEmbed.scaleToFit(555, 800);
                    page.drawImage(imgEmbed, {x: (595-dims.width)/2, y: (841-dims.height)/2, width: dims.width, height: dims.height});
                } else {
                    page.drawImage(imgEmbed, {x:0, y:0, width, height});
                }
            }
        }
        downloadBlob(new Blob([await pdfDoc.save()], {type:'application/pdf'}), 'merged.pdf');
    }

    async function handleSplitFileVisual(files) {
        if(!files.length) return;
        currentSplitFile = files[0];
        document.getElementById('split-input-group').style.display = 'none';
        document.getElementById('split-editor-container').style.display = 'block';
        const buffer = await files[0].arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        const container = document.getElementById('split-visual-area');
        container.innerHTML = '';
        for(let i=1; i<=pdf.numPages; i++){
            const page = await pdf.getPage(i);
            const cvs = document.createElement('canvas');
            const vp = page.getViewport({scale:0.3});
            cvs.width=vp.width; cvs.height=vp.height;
            await page.render({canvasContext:cvs.getContext('2d'), viewport:vp}).promise;
            const div = document.createElement('div');
            div.className='preview-item'; div.dataset.idx=i-1;
            const img = document.createElement('img'); img.src=cvs.toDataURL();
            const btn = document.createElement('button'); btn.className='remove-btn'; btn.innerHTML='Ã—';
            btn.onclick=()=>{div.remove();};
            div.append(btn, img); container.append(div);
        }
    }
    
    function resetSplitView() {
        document.getElementById('split-input-group').style.display = 'block';
        document.getElementById('split-editor-container').style.display = 'none';
    }

    async function executeSplitVisual() {
        const items = document.querySelectorAll('#split-visual-area .preview-item');
        if(!items.length) return;
        const indices = Array.from(items).map(i => parseInt(i.dataset.idx));
        const srcPdf = await PDFDocument.load(await currentSplitFile.arrayBuffer());
        const mode = document.getElementById('splitOutputMode').value;
        if(mode === 'merge_remaining') {
            const newPdf = await PDFDocument.create();
            (await newPdf.copyPages(srcPdf, indices)).forEach(p => newPdf.addPage(p));
            downloadBlob(new Blob([await newPdf.save()], {type:'application/pdf'}), 'edited.pdf');
        } else {
            const zip = new JSZip();
            for(let i=0; i<indices.length; i++) {
                const newPdf = await PDFDocument.create();
                (await newPdf.copyPages(srcPdf, [indices[i]])).forEach(p => newPdf.addPage(p));
                zip.file(`page_${i+1}.pdf`, await newPdf.save());
            }
            downloadBlob(await zip.generateAsync({type:'blob'}), 'split_pages.zip');
        }
    }

    // åœ–ç‰‡åˆ†å‰²èˆ‡è½‰æª”åŠŸèƒ½è«‹åƒè€ƒå‰ç‰ˆï¼Œç‚ºç¯€çœç©ºé–“èˆ‡é¿å…é‡è¤‡ï¼Œä½¿ç”¨é€šç”¨å‡½å¼æ”¯æ´
    const imgSplitArea = document.getElementById('img-split-preview-area');
    function handleImgSplitFiles(files) {
        if(files.length) Array.from(files).forEach(f => createPreviewItem(f, imgSplitArea));
        document.getElementById('imgSplitInput').value = '';
    }
    
    async function executeImageSplit() {
        const items = document.querySelectorAll('#img-split-preview-area .preview-item');
        if(!items.length) return alert('è«‹é¸åœ–');
        const pdfDoc = await PDFDocument.create();
        for(let i=0; i<items.length; i++) {
            const img = await loadImage(await readFileAsDataURL(items[i].fileData));
            const cvsL = document.createElement('canvas'), cvsR = document.createElement('canvas');
            const w = Math.floor(img.width/2), h = img.height;
            cvsL.width=w; cvsL.height=h; cvsR.width=w; cvsR.height=h;
            cvsL.getContext('2d').drawImage(img,0,0,w,h,0,0,w,h);
            cvsR.getContext('2d').drawImage(img,w,0,w,h,0,0,w,h);
            
            const bufL = await new Promise(r=>cvsL.toBlob(b=>r(b.arrayBuffer()),'image/jpeg',0.9));
            const bufR = await new Promise(r=>cvsR.toBlob(b=>r(b.arrayBuffer()),'image/jpeg',0.9));
            const iL = await pdfDoc.embedJpg(bufL), iR = await pdfDoc.embedJpg(bufR);
            
            const list = document.getElementById('splitDirection').value === 'ltr' ? [iL, iR] : [iR, iL];
            list.forEach(im => {
                const p = pdfDoc.addPage([595.28, 841.89]);
                const d = im.scaleToFit(555, 800);
                p.drawImage(im, {x:(595-d.width)/2, y:(841-d.height)/2, width:d.width, height:d.height});
            });
        }
        downloadBlob(new Blob([await pdfDoc.save()], {type:'application/pdf'}), 'split_images.pdf');
    }

    function handleConvertFile(files) { if(files.length) { currentConvertFile=files[0]; document.getElementById('convert-file-name').innerText = files[0].name; document.getElementById('convert-file-name').style.display='block'; } }
    async function executePdfToImage() {
        if(!currentConvertFile) return;
        const pdf = await pdfjsLib.getDocument(await currentConvertFile.arrayBuffer()).promise;
        const zip = new JSZip();
        for(let i=1; i<=pdf.numPages; i++) {
            const p = await pdf.getPage(i);
            const cvs = document.createElement('canvas');
            const vp = p.getViewport({scale: parseFloat(document.getElementById('renderScale').value)});
            cvs.width=vp.width; cvs.height=vp.height;
            await p.render({canvasContext:cvs.getContext('2d'), viewport:vp}).promise;
            const fmt = document.getElementById('outputFormat').value;
            const blob = await new Promise(r=>cvs.toBlob(r, fmt==='jpeg'?'image/jpeg':'image/png', 0.9));
            zip.file(`page_${i}.${fmt==='jpeg'?'jpg':'png'}`, blob);
        }
        downloadBlob(await zip.generateAsync({type:'blob'}), 'images.zip');
    }

    // --- è¼”åŠ© ---
    function readFileAsDataURL(file) { return new Promise((r,j)=>{const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(file);}); }
    function loadImage(url) { return new Promise((r)=>{const i=new Image(); i.onload=()=>r(i); i.src=url;}); }
    function convertToJpegBuffer(img, q) {
        return new Promise(r=>{
            const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
            const ctx=c.getContext('2d'); ctx.fillStyle='#FFF'; ctx.fillRect(0,0,c.width,c.height); ctx.drawImage(img,0,0);
            c.toBlob(b=>{ const fr=new FileReader(); fr.onload=()=>r({buffer:fr.result, width:img.width, height:img.height}); fr.readAsArrayBuffer(b); }, 'image/jpeg', q);
        });
    }
    function downloadBlob(blob, name) { const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }
</script>
</body>
</html>
