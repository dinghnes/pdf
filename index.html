<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF å…¨èƒ½å·¥å…·ç®± (å«åœ–ç‰‡åˆ†å‰²åŠŸèƒ½)</title>
    <!-- 1. æ ¸å¿ƒå¼•æ“ï¼špdf-lib (æ›´æ›ç‚º cdnjs ä»¥æé«˜ç©©å®šæ€§) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <!-- 2. å£“ç¸®å·¥å…·ï¼šJSZip (ç”¨æ–¼æ‰“åŒ…ä¸‹è¼‰) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 3. æ¸²æŸ“å¼•æ“ï¼špdf.js (ç”¨æ–¼ PDF è½‰åœ–ç‰‡èˆ‡è¦–è¦ºåŒ–é è¦½) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script>
        // è¨­å®š pdf.js worker
        window.onload = function() {
            if (window.pdfjsLib) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        };
    </script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 900px;
        }

        h1 { color: #333; margin-bottom: 1rem; }

        /* åˆ†é æ¨™ç±¤æ¨£å¼ */
        .tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œä»¥é©æ‡‰å°è¢å¹• */
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            font-size: 0.95rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: white;
            background-color: #007bff;
        }

        .tab-btn:hover:not(.active) { color: #555; background-color: #f0f0f0; }

        /* é€šç”¨æ¨£å¼ */
        .input-group {
            margin-bottom: 1.5rem;
            text-align: center;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .input-group:hover { border-color: #007bff; }

        input[type="file"] { display: none; }

        .custom-file-label {
            cursor: pointer;
            color: #007bff;
            font-weight: bold;
            display: block;
        }
        
        .settings-group {
            margin: 15px 0;
            text-align: left;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            display: grid;
            gap: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .setting-item label {
            font-weight: bold;
            color: #555;
            margin-right: 10px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .setting-item select, .setting-item input[type="text"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
        }

        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button.action-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        button.action-btn:hover { background-color: #0056b3; }
        button.action-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* é è¦½å€ (Grid) */
        .grid-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            min-height: 50px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        .preview-item {
            position: relative;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .preview-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .preview-item.dragging { opacity: 0.5; border: 2px dashed #007bff; }
        
        .preview-item img { 
            width: 100%; 
            height: 140px; 
            object-fit: contain; 
            border-radius: 4px; 
            background-color: #f0f0f0;
            pointer-events: none; 
        }
        
        .preview-item .pdf-icon {
            width: 100%; height: 140px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background-color: #fce4ec; color: #d32f2f; border-radius: 4px; font-weight: bold;
        }
        
        .preview-item .file-name {
            font-size: 10px; color: #666; margin-top: 4px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; text-align: center;
        }

        .remove-btn {
            position: absolute; top: -5px; right: -5px;
            background: #ff4d4d; color: white; border: none; border-radius: 50%;
            width: 24px; height: 24px; line-height: 24px; text-align: center;
            cursor: pointer; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2;
        }

        .page-badge { 
            font-size: 12px; 
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 5px;
            color: #333; 
        }

        .status-msg { margin-top: 1rem; font-size: 0.9rem; color: #666; }

        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* æª”æ¡ˆåç¨±é¡¯ç¤º */
        .selected-file-name {
            color: #28a745;
            font-weight: bold;
            margin-bottom: 10px;
            display: none;
        }

        .split-hint {
            background-color: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: left;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>PDF å…¨èƒ½å·¥å…·ç®±</h1>
    
    <!-- åˆ†é åˆ‡æ› -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('merge')">1. åˆä½µ PDF/åœ–ç‰‡</button>
        <button class="tab-btn" onclick="switchTab('split')">2. æ‹†åˆ† / ç·¨è¼¯ PDF</button>
        <button class="tab-btn" onclick="switchTab('img-split')">3. åœ–ç‰‡åˆ†å‰² (å·¦å³åˆ‡é–‹)</button>
        <button class="tab-btn" onclick="switchTab('convert')">4. PDF è½‰åœ–ç‰‡</button>
    </div>

    <!-- ================= 1. åˆä½µæ¨¡å¼ (Merge Mode) ================= -->
    <div id="merge-view" class="view-section active">
        <div class="input-group">
            <label for="mergeInput" class="custom-file-label">
                ğŸ“‚ é¸æ“‡åœ–ç‰‡æˆ– PDF æª”æ¡ˆ<br>
                <span style="font-size: 0.8rem; color: #999; font-weight: normal;">(æ”¯æ´å¤šæª”æ··åˆåˆä½µã€æ‹–æ›³æ’åº)</span>
            </label>
            <input type="file" id="mergeInput" accept="image/*, .pdf" multiple onchange="handleMergeFiles(this.files)">
        </div>

        <div class="settings-group">
            <div class="setting-item">
                <label for="pageSize">ğŸ“„ è¼¸å‡ºé é¢å¤§å°ï¼š</label>
                <select id="pageSize">
                    <option value="original" selected>ä¾ç…§åœ–ç‰‡åŸå°ºå¯¸ (ç„¡ç•™ç™½)</option>
                    <option value="a4">A4 æ¨™æº–ç´™å¼µ (å¯èƒ½æœƒæœ‰ç™½é‚Š)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="quality">ğŸ—œï¸ åœ–ç‰‡å£“ç¸®å“è³ªï¼š</label>
                <select id="quality">
                    <option value="0.95" selected>é«˜ç•«è³ª (æª”æ¡ˆè¼ƒå¤§)</option>
                    <option value="0.75">æ¨™æº–å£“ç¸® (å»ºè­°ä½¿ç”¨)</option>
                    <option value="0.5">é«˜å£“ç¸® (æª”æ¡ˆæœ€å°)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="showPageNumbers" style="cursor: pointer;">
                    ğŸ”¢ é¡¯ç¤ºé ç¢¼ (1/N)ï¼š
                </label>
                <input type="checkbox" id="showPageNumbers">
            </div>
        </div>

        <div id="merge-preview-area" class="grid-area"></div>

        <button id="convertBtn" class="action-btn" onclick="generateMergedPDF()">é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰</button>
        <div id="merge-status" class="status-msg"></div>
    </div>

    <!-- ================= 2. æ‹†åˆ†/ç·¨è¼¯æ¨¡å¼ (Split PDF Mode) ================= -->
    <div id="split-view" class="view-section">
        <div class="input-group" id="split-input-group">
            <label for="splitInput" class="custom-file-label">
                âœ‚ï¸ é¸æ“‡å–®å€‹ PDF æª”æ¡ˆ<br>
                <span style="font-size: 0.8rem; color: #999; font-weight: normal;">(è®€å–ä¸¦åˆ—å‡ºæ‰€æœ‰é é¢ï¼Œå¯è‡ªç”±åˆªé™¤)</span>
            </label>
            <input type="file" id="splitInput" accept=".pdf" onchange="handleSplitFileVisual(this.files)">
        </div>
        
        <div id="split-file-name" class="selected-file-name"></div>

        <!-- è¦–è¦ºåŒ–ç·¨è¼¯å€åŸŸ -->
        <div id="split-editor-container" style="display: none;">
            <div class="split-hint">
                ğŸ’¡ <strong>æ“ä½œèªªæ˜ï¼š</strong> é»æ“Š <strong>ç´…è‰² X</strong> åˆªé™¤ä¸è¦çš„é é¢ã€‚å‰©ä¸‹çš„é é¢å°‡æœƒè¢«åŒ¯å‡ºã€‚
            </div>
            
            <div id="split-visual-area" class="grid-area"></div>

            <div class="settings-group">
                <div class="setting-item">
                    <label for="splitOutputMode">ğŸ’¾ åŒ¯å‡ºæ–¹å¼ï¼š</label>
                    <select id="splitOutputMode">
                        <option value="merge_remaining">å„²å­˜ç‚ºå–®ä¸€ PDF (åˆä½µå‰©é¤˜é é¢)</option>
                        <option value="split_remaining">å„²å­˜ç‚ºå¤šå€‹ PDF (æ‹†åˆ†å‰©é¤˜é é¢)</option>
                    </select>
                </div>
            </div>

            <button id="splitBtn" class="action-btn" onclick="executeSplitVisual()">åŸ·è¡ŒåŒ¯å‡º</button>
            <button class="action-btn" style="background-color: #6c757d; margin-top: 10px;" onclick="resetSplitView()">é‡æ–°é¸æ“‡æª”æ¡ˆ</button>
        </div>
        
        <div id="split-status" class="status-msg"></div>
    </div>

    <!-- ================= 3. åœ–ç‰‡åˆ†å‰²æ¨¡å¼ (Image Split Mode) - NEW ================= -->
    <div id="img-split-view" class="view-section">
        <div class="input-group">
            <label for="imgSplitInput" class="custom-file-label">
                ğŸ“– é¸æ“‡åœ–ç‰‡æª”æ¡ˆ (JPG/PNG)<br>
                <span style="font-size: 0.8rem; color: #999; font-weight: normal;">(å°‡ä¸€å¼µæ©«å‘åœ–ç‰‡åˆ‡æˆå…©é  A4)</span>
            </label>
            <input type="file" id="imgSplitInput" accept="image/*" multiple onchange="handleImgSplitFiles(this.files)">
        </div>

        <div id="img-split-preview-area" class="grid-area"></div>

        <div class="settings-group">
            <div class="setting-item">
                <label for="splitDirection">ğŸ“– é–±è®€æ–¹å‘ (é åº)ï¼š</label>
                <select id="splitDirection">
                    <option value="ltr" selected>å·¦ç¿»æ›¸ (å·¦é‚Šæ˜¯ç¬¬1é ï¼Œå³é‚Šæ˜¯ç¬¬2é )</option>
                    <option value="rtl">å³ç¿»æ›¸ (å³é‚Šæ˜¯ç¬¬1é ï¼Œå·¦é‚Šæ˜¯ç¬¬2é )</option>
                </select>
            </div>
            <div class="split-hint">
                â„¹ï¸ è¼¸å‡ºèªªæ˜ï¼šæ¯å¼µåœ–ç‰‡æœƒè¢«å‚ç›´å¾ä¸­é–“åˆ‡é–‹ï¼Œè‡ªå‹•ç¸®æ”¾ä¸¦æ”¾å…¥å…©é  A4 PDF ä¸­ã€‚
            </div>
        </div>

        <button id="imgSplitBtn" class="action-btn" onclick="executeImageSplit()">åˆ†å‰²ä¸¦è½‰æ›ç‚º PDF</button>
        <div id="img-split-status" class="status-msg"></div>
    </div>

    <!-- ================= 4. è½‰åœ–ç‰‡æ¨¡å¼ (Convert Mode) ================= -->
    <div id="convert-view" class="view-section">
        <div class="input-group">
            <label for="convertInput" class="custom-file-label">
                ğŸ–¼ï¸ é¸æ“‡å–®å€‹ PDF æª”æ¡ˆ<br>
                <span style="font-size: 0.8rem; color: #999; font-weight: normal;">(å°‡ PDF è½‰æˆ JPG/PNG åœ–ç‰‡)</span>
            </label>
            <input type="file" id="convertInput" accept=".pdf" onchange="handleConvertFile(this.files)">
        </div>

        <div id="convert-file-name" class="selected-file-name"></div>

        <div class="settings-group">
            <div class="setting-item">
                <label for="outputFormat">ğŸ’¾ è¼¸å‡ºæ ¼å¼ï¼š</label>
                <select id="outputFormat">
                    <option value="jpeg">JPG (é©åˆç…§ç‰‡/ä¸€èˆ¬æ–‡ä»¶)</option>
                    <option value="png">PNG (é©åˆç·šæ¢/æ–‡å­—)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="renderScale">ğŸ” è§£æåº¦ (æ¸…æ™°åº¦)ï¼š</label>
                <select id="renderScale">
                    <option value="1">æ¨™æº– (72 DPI - é©åˆè¢å¹•)</option>
                    <option value="2" selected>é«˜ç•«è³ª (150 DPI - å»ºè­°)</option>
                    <option value="3">è¶…é«˜ç•«è³ª (300 DPI - é©åˆåˆ—å°)</option>
                </select>
            </div>
        </div>

        <button id="toImageBtn" class="action-btn" onclick="executePdfToImage()">è½‰æ›ç‚ºåœ–ç‰‡ä¸¦ä¸‹è¼‰ (ZIP)</button>
        <div id="convert-status" class="status-msg"></div>
    </div>

</div>

<script>
    // æª¢æŸ¥ PDFLib æ˜¯å¦å·²è¼‰å…¥
    const PDFLib = window.PDFLib;
    if (!PDFLib) {
        console.error("PDFLib æœªæ­£ç¢ºè¼‰å…¥");
    }

    const { PDFDocument, rgb, StandardFonts } = PDFLib || {};

    window.addEventListener('load', () => {
        if (!window.PDFLib) {
            alert("éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ PDF è™•ç†æ ¸å¿ƒ (pdf-lib)ã€‚\nè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šï¼Œæˆ–å˜—è©¦é‡æ–°æ•´ç†é é¢ã€‚");
        }
    });
    
    // å…¨åŸŸè®Šæ•¸
    let currentSplitFile = null;
    let currentConvertFile = null;

    // --- Tab åˆ‡æ›é‚è¼¯ ---
    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));
        
        const tabs = document.querySelectorAll('.tab-btn');
        if (mode === 'merge') {
            tabs[0].classList.add('active');
            document.getElementById('merge-view').classList.add('active');
        } else if (mode === 'split') {
            tabs[1].classList.add('active');
            document.getElementById('split-view').classList.add('active');
        } else if (mode === 'img-split') {
            tabs[2].classList.add('active');
            document.getElementById('img-split-view').classList.add('active');
        } else {
            tabs[3].classList.add('active');
            document.getElementById('convert-view').classList.add('active');
        }
    }

    // ==========================================
    // 1. åˆä½µæ¨¡å¼é‚è¼¯
    // ==========================================
    const mergePreviewArea = document.getElementById('merge-preview-area');
    let dragSrcEl = null;

    function handleMergeFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => createMergePreviewItem(file));
        document.getElementById('mergeInput').value = '';
        updateOrderNumbers();
    }

    function createMergePreviewItem(file) {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.draggable = true;
        div.fileData = file;

        if (file.type === 'application/pdf') {
            const pdfIcon = document.createElement('div');
            pdfIcon.className = 'pdf-icon';
            pdfIcon.innerHTML = '<span>PDF</span>';
            div.appendChild(pdfIcon);
        } else {
            const img = document.createElement('img');
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; };
            reader.readAsDataURL(file);
            div.appendChild(img);
        }

        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.innerText = file.name;
        div.appendChild(fileName);

        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.innerHTML = 'Ã—';
        btn.onclick = function() { div.remove(); updateOrderNumbers(); };

        const pageNum = document.createElement('div');
        pageNum.className = 'page-badge';
        pageNum.innerText = 'Item';

        div.appendChild(btn);
        div.appendChild(pageNum);
        addDragEvents(div);
        mergePreviewArea.appendChild(div);
    }

    function addDragEvents(item) {
        item.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        });
        item.addEventListener('dragover', function(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        });
        item.addEventListener('drop', function(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                const items = Array.from(mergePreviewArea.children);
                if (items.indexOf(dragSrcEl) < items.indexOf(this)) { this.after(dragSrcEl); } 
                else { this.before(dragSrcEl); }
            }
            return false;
        });
        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            updateOrderNumbers();
        });
    }

    function updateOrderNumbers() {
        document.querySelectorAll('#merge-preview-area .preview-item .page-badge').forEach((item, index) => {
            item.innerText = `é †åº ${index + 1}`;
        });
    }

    async function generateMergedPDF() {
        if (!PDFLib) { alert("PDF æ ¸å¿ƒåº«æœªè¼‰å…¥"); return; }
        
        const items = document.querySelectorAll('#merge-preview-area .preview-item');
        const status = document.getElementById('merge-status');
        const btn = document.getElementById('convertBtn');
        const pageSizeMode = document.getElementById('pageSize').value;
        const quality = parseFloat(document.getElementById('quality').value);
        const showPageNumbers = document.getElementById('showPageNumbers').checked;

        if (items.length === 0) { alert("è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹æª”æ¡ˆï¼"); return; }
        btn.disabled = true; btn.innerText = "è™•ç†ä¸­..."; status.innerText = "æº–å‚™åˆä½µ...";

        try {
            const pdfDoc = await PDFDocument.create();
            let font;
            if (showPageNumbers) font = await pdfDoc.embedFont(StandardFonts.Helvetica);

            for (let i = 0; i < items.length; i++) {
                const file = items[i].fileData;
                status.innerText = `æ­£åœ¨è™•ç†é …ç›® ${i + 1}/${items.length}...`;

                if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const srcPdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await pdfDoc.copyPages(srcPdf, srcPdf.getPageIndices());
                    copiedPages.forEach((page) => pdfDoc.addPage(page));
                } else {
                    const rawData = await readFileAsDataURL(file);
                    const imgObj = await loadImage(rawData);
                    const { buffer, width, height } = await convertToJpegBuffer(imgObj, quality);
                    const jpgImage = await pdfDoc.embedJpg(buffer);

                    let page;
                    if (pageSizeMode === 'original') {
                        page = pdfDoc.addPage([width, height]);
                        page.drawImage(jpgImage, { x: 0, y: 0, width, height });
                    } else {
                        const a4W = 595.28, a4H = 841.89, margin = 20;
                        page = pdfDoc.addPage([a4W, a4H]);
                        const dims = jpgImage.scaleToFit(a4W - margin*2, a4H - margin*2);
                        page.drawImage(jpgImage, { x: margin, y: a4H - margin - dims.height, width: dims.width, height: dims.height });
                    }
                }
            }

            if (showPageNumbers) {
                const pages = pdfDoc.getPages();
                pages.forEach((page, idx) => {
                    const text = `${idx + 1} / ${pages.length}`;
                    const size = 12;
                    const tw = font.widthOfTextAtSize(text, size);
                    const { width } = page.getSize();
                    page.drawRectangle({ x: (width/2)-(tw/2)-5, y: 15, width: tw+10, height: size+10, color: rgb(1,1,1), opacity: 0.8 });
                    page.drawText(text, { x: (width/2)-(tw/2), y: 22, size, font, color: rgb(0,0,0) });
                });
            }

            const pdfBytes = await pdfDoc.save();
            downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), 'merged-files.pdf');
            status.innerText = "åˆä½µå®Œæˆï¼";
        } catch (e) {
            console.error(e); alert("éŒ¯èª¤: " + e.message); status.innerText = "ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            btn.disabled = false; btn.innerText = "é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰";
        }
    }

    // ==========================================
    // 2. æ‹†åˆ†/ç·¨è¼¯æ¨¡å¼ (Visual Editor)
    // ==========================================
    async function handleSplitFileVisual(files) {
        if (!files.length) return;
        currentSplitFile = files[0];
        
        const status = document.getElementById('split-status');
        const visualArea = document.getElementById('split-visual-area');
        const editorContainer = document.getElementById('split-editor-container');
        const inputGroup = document.getElementById('split-input-group');
        
        status.innerText = "æ­£åœ¨è®€å– PDF é é¢...";
        visualArea.innerHTML = ''; 
        
        try {
            const arrayBuffer = await currentSplitFile.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument(arrayBuffer);
            const pdf = await loadingTask.promise;
            const totalPages = pdf.numPages;
            
            inputGroup.style.display = 'none';
            editorContainer.style.display = 'block';
            document.getElementById('split-file-name').innerText = `ç·¨è¼¯æª”æ¡ˆ: ${currentSplitFile.name} (å…± ${totalPages} é )`;

            for (let i = 1; i <= totalPages; i++) {
                status.innerText = `æ­£åœ¨æ¸²æŸ“é è¦½åœ–: ${i} / ${totalPages}`;
                
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 0.3 });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                const imgDataUrl = canvas.toDataURL();
                createSplitVisualItem(imgDataUrl, i);
            }
            status.innerText = "é è¦½è¼‰å…¥å®Œæˆã€‚";
        } catch (error) {
            console.error(error);
            alert("è®€å– PDF å¤±æ•—: " + error.message);
            resetSplitView();
        }
    }

    function createSplitVisualItem(imgSrc, pageNum) {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.dataset.pageIndex = pageNum - 1;

        const img = document.createElement('img');
        img.src = imgSrc;
        
        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.innerHTML = 'Ã—';
        btn.onclick = function(e) { 
            e.stopPropagation();
            div.remove(); 
        };

        const badge = document.createElement('div');
        badge.className = 'page-badge';
        badge.innerText = `ç¬¬ ${pageNum} é `;

        div.appendChild(btn);
        div.appendChild(img);
        div.appendChild(badge);
        
        document.getElementById('split-visual-area').appendChild(div);
    }

    async function executeSplitVisual() {
        if (!PDFLib) { alert("PDF æ ¸å¿ƒåº«æœªè¼‰å…¥"); return; }
        
        const status = document.getElementById('split-status');
        const btn = document.getElementById('splitBtn');
        const mode = document.getElementById('splitOutputMode').value;
        const visualItems = document.querySelectorAll('#split-visual-area .preview-item');

        if (visualItems.length === 0) { alert("æ²’æœ‰å‰©é¤˜çš„é é¢å¯ä»¥åŒ¯å‡ºï¼"); return; }
        
        btn.disabled = true; btn.innerText = "è™•ç†ä¸­..."; 
        status.innerText = "æ­£åœ¨è™•ç†...";

        try {
            const indicesToKeep = Array.from(visualItems).map(item => parseInt(item.dataset.pageIndex));
            const arrayBuffer = await currentSplitFile.arrayBuffer();
            const srcPdf = await PDFDocument.load(arrayBuffer);
            const fileNameBase = currentSplitFile.name.replace('.pdf', '');

            if (mode === 'merge_remaining') {
                const newPdf = await PDFDocument.create();
                const copiedPages = await newPdf.copyPages(srcPdf, indicesToKeep);
                copiedPages.forEach(page => newPdf.addPage(page));
                const pdfBytes = await newPdf.save();
                downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), `${fileNameBase}_edited.pdf`);
                status.innerText = `åŒ¯å‡ºå®Œæˆï¼å…± ${indicesToKeep.length} é ã€‚`;
            } else {
                const zip = new JSZip();
                for (let i = 0; i < indicesToKeep.length; i++) {
                    const originalIndex = indicesToKeep[i];
                    const displayNum = originalIndex + 1;
                    const newPdf = await PDFDocument.create();
                    const [copiedPage] = await newPdf.copyPages(srcPdf, [originalIndex]);
                    newPdf.addPage(copiedPage);
                    const pdfBytes = await newPdf.save();
                    zip.file(`${fileNameBase}_page_${displayNum}.pdf`, pdfBytes);
                }
                const zipContent = await zip.generateAsync({ type: "blob" });
                downloadBlob(zipContent, `${fileNameBase}_pages.zip`);
                status.innerText = "åŒ¯å‡ºå®Œæˆï¼ZIP å·²ä¸‹è¼‰ã€‚";
            }
        } catch (error) {
            console.error(error);
            alert("è™•ç†å¤±æ•—: " + error.message);
            status.innerText = "ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            btn.disabled = false; btn.innerText = "åŸ·è¡ŒåŒ¯å‡º";
        }
    }

    function resetSplitView() {
        currentSplitFile = null;
        document.getElementById('split-input-group').style.display = 'block';
        document.getElementById('split-editor-container').style.display = 'none';
        document.getElementById('split-visual-area').innerHTML = '';
        document.getElementById('split-file-name').innerText = '';
        document.getElementById('splitInput').value = '';
        document.getElementById('split-status').innerText = '';
    }

    // ==========================================
    // 3. åœ–ç‰‡åˆ†å‰²æ¨¡å¼ (Image Split Mode) - NEW
    // ==========================================
    const imgSplitPreviewArea = document.getElementById('img-split-preview-area');
    
    function handleImgSplitFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.fileData = file;

            const img = document.createElement('img');
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; };
            reader.readAsDataURL(file);

            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.innerText = file.name;

            const btn = document.createElement('button');
            btn.className = 'remove-btn';
            btn.innerHTML = 'Ã—';
            btn.onclick = function() { div.remove(); };

            div.appendChild(btn);
            div.appendChild(img);
            div.appendChild(fileName);
            imgSplitPreviewArea.appendChild(div);
        });
        document.getElementById('imgSplitInput').value = '';
    }

    async function executeImageSplit() {
        if (!PDFLib) { alert("PDF æ ¸å¿ƒåº«æœªè¼‰å…¥"); return; }
        
        const items = document.querySelectorAll('#img-split-preview-area .preview-item');
        const status = document.getElementById('img-split-status');
        const btn = document.getElementById('imgSplitBtn');
        const direction = document.getElementById('splitDirection').value; // ltr or rtl
        
        if (items.length === 0) { alert("è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å¼µåœ–ç‰‡ï¼"); return; }
        
        btn.disabled = true; btn.innerText = "è™•ç†ä¸­..."; status.innerText = "æ­£åœ¨åˆ†å‰²åœ–ç‰‡...";

        try {
            const pdfDoc = await PDFDocument.create();
            // A4 å°ºå¯¸ (points)
            const a4W = 595.28;
            const a4H = 841.89;
            const margin = 20;

            for (let i = 0; i < items.length; i++) {
                const file = items[i].fileData;
                status.innerText = `æ­£åœ¨è™•ç† ${file.name}...`;

                // 1. è®€å–åœ–ç‰‡
                const rawData = await readFileAsDataURL(file);
                const imgObj = await loadImage(rawData);
                
                // 2. åˆ©ç”¨ Canvas åˆ‡å‰²åœ–ç‰‡
                // å·¦åŠé‚Š
                const canvasL = document.createElement('canvas');
                canvasL.width = Math.floor(imgObj.width / 2);
                canvasL.height = imgObj.height;
                const ctxL = canvasL.getContext('2d');
                // drawImage(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
                ctxL.drawImage(imgObj, 0, 0, canvasL.width, canvasL.height, 0, 0, canvasL.width, canvasL.height);
                
                // å³åŠé‚Š
                const canvasR = document.createElement('canvas');
                canvasR.width = Math.floor(imgObj.width / 2);
                canvasR.height = imgObj.height;
                const ctxR = canvasR.getContext('2d');
                ctxR.drawImage(imgObj, canvasL.width, 0, canvasR.width, canvasR.height, 0, 0, canvasR.width, canvasR.height);

                // 3. è½‰ç‚º JPEG Buffer
                const blobL = await new Promise(r => canvasL.toBlob(r, 'image/jpeg', 0.9));
                const blobR = await new Promise(r => canvasR.toBlob(r, 'image/jpeg', 0.9));
                
                const bufferL = await blobL.arrayBuffer();
                const bufferR = await blobR.arrayBuffer();

                // 4. åµŒå…¥ PDF
                const imgL = await pdfDoc.embedJpg(bufferL);
                const imgR = await pdfDoc.embedJpg(bufferR);

                // 5. åŠ å…¥é é¢ (ä¾æ–¹å‘)
                const pagesToAdd = direction === 'ltr' ? [imgL, imgR] : [imgR, imgL];

                for (const imgPart of pagesToAdd) {
                    const page = pdfDoc.addPage([a4W, a4H]);
                    // ç¸®æ”¾ä¸¦ç½®ä¸­
                    const dims = imgPart.scaleToFit(a4W - margin*2, a4H - margin*2);
                    page.drawImage(imgPart, {
                        x: (a4W - dims.width) / 2, // æ°´å¹³ç½®ä¸­
                        y: (a4H - dims.height) / 2, // å‚ç›´ç½®ä¸­
                        width: dims.width,
                        height: dims.height,
                    });
                }
            }

            const pdfBytes = await pdfDoc.save();
            downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), 'split_images.pdf');
            status.innerText = "è™•ç†å®Œæˆï¼PDF å·²ä¸‹è¼‰ã€‚";

        } catch (error) {
            console.error(error);
            alert("è™•ç†å¤±æ•—: " + error.message);
            status.innerText = "ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            btn.disabled = false; btn.innerText = "åˆ†å‰²ä¸¦è½‰æ›ç‚º PDF";
        }
    }

    // ==========================================
    // 4. è½‰åœ–ç‰‡æ¨¡å¼é‚è¼¯
    // ==========================================
    function handleConvertFile(files) {
        if (!files.length) return;
        currentConvertFile = files[0];
        const nameDisplay = document.getElementById('convert-file-name');
        nameDisplay.style.display = 'block';
        nameDisplay.innerText = `å·²é¸æ“‡æª”æ¡ˆ: ${currentConvertFile.name}`;
    }

    async function executePdfToImage() {
        const status = document.getElementById('convert-status');
        const btn = document.getElementById('toImageBtn');
        const format = document.getElementById('outputFormat').value; // jpeg or png
        const scale = parseFloat(document.getElementById('renderScale').value);

        if (!currentConvertFile) { alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ PDF æª”æ¡ˆï¼"); return; }

        btn.disabled = true; btn.innerText = "è½‰æ›ä¸­..."; status.innerText = "æ­£åœ¨è®€å– PDF...";

        try {
            const arrayBuffer = await currentConvertFile.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument(arrayBuffer);
            const pdf = await loadingTask.promise;
            const totalPages = pdf.numPages;
            
            status.innerText = `PDF å…±æœ‰ ${totalPages} é ï¼Œæº–å‚™è½‰æ›...`;
            
            const zip = new JSZip();
            const fileNameBase = currentConvertFile.name.replace('.pdf', '');

            for (let i = 1; i <= totalPages; i++) {
                status.innerText = `æ­£åœ¨è½‰æ›ç¬¬ ${i} / ${totalPages} é ...`;
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: scale });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;

                const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';
                const blob = await new Promise(resolve => canvas.toBlob(resolve, mimeType, 0.9));
                const ext = format === 'jpeg' ? 'jpg' : 'png';
                zip.file(`${fileNameBase}_page_${i}.${ext}`, blob);
            }

            status.innerText = "è½‰æ›å®Œæˆï¼Œæ­£åœ¨æ‰“åŒ…ä¸‹è¼‰...";
            const zipContent = await zip.generateAsync({ type: "blob" });
            downloadBlob(zipContent, `${fileNameBase}_images.zip`);
            status.innerText = "ä¸‹è¼‰å®Œæˆï¼";

        } catch (error) {
            console.error(error);
            alert("è½‰æ›å¤±æ•—: " + error.message);
            status.innerText = "ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            btn.disabled = false; btn.innerText = "è½‰æ›ç‚ºåœ–ç‰‡ä¸¦ä¸‹è¼‰ (ZIP)";
        }
    }

    // ==========================================
    // 5. é€šç”¨è¼”åŠ©å‡½å¼
    // ==========================================
    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function loadImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = url;
        });
    }

    function convertToJpegBuffer(img, quality) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ buffer: reader.result, width: img.width, height: img.height });
                reader.readAsArrayBuffer(blob);
            }, 'image/jpeg', quality);
        });
    }

    function downloadBlob(blob, fileName) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    }
</script>

</body>
</html>
