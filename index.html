<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF åˆä½µ/æ‹†åˆ†å·¥å…·</title>
    <!-- æ ¸å¿ƒå¼•æ“ï¼špdf-lib -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- å£“ç¸®å·¥å…·ï¼šJSZip (ç”¨æ–¼æ‰“åŒ…æ‹†åˆ†å¾Œçš„æª”æ¡ˆ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        h1 { color: #333; margin-bottom: 1rem; }

        /* åˆ†é æ¨™ç±¤æ¨£å¼ */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }

        .tab-btn:hover:not(.active) {
            color: #555;
        }

        /* é€šç”¨æ¨£å¼ */
        .input-group {
            margin-bottom: 1.5rem;
            text-align: center;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .input-group:hover { border-color: #007bff; }

        input[type="file"] { display: none; }

        .custom-file-label {
            cursor: pointer;
            color: #007bff;
            font-weight: bold;
            display: block;
        }
        
        .settings-group {
            margin: 15px 0;
            text-align: left;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            display: grid;
            gap: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .setting-item label {
            font-weight: bold;
            color: #555;
            margin-right: 10px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .setting-item select, .setting-item input[type="text"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
        }

        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        button.action-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        button.action-btn:hover { background-color: #0056b3; }
        button.action-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* é è¦½å€ (åˆä½µæ¨¡å¼) */
        #preview-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
            min-height: 50px;
        }

        .preview-item {
            position: relative;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
            cursor: move;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .preview-item.dragging { opacity: 0.5; border: 2px dashed #007bff; }
        .preview-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; pointer-events: none; }
        
        .preview-item .pdf-icon {
            width: 100%; height: 100px; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background-color: #fce4ec; color: #d32f2f; border-radius: 4px; font-weight: bold;
        }
        
        .preview-item .file-name {
            font-size: 10px; color: #666; margin-top: 4px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100px;
        }

        .remove-btn {
            position: absolute; top: -8px; right: -8px;
            background: #ff4d4d; color: white; border: none; border-radius: 50%;
            width: 24px; height: 24px; line-height: 24px; text-align: center;
            cursor: pointer; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 2;
        }

        .page-number { font-size: 12px; color: #666; margin-top: 5px; }

        .status-msg { margin-top: 1rem; font-size: 0.9rem; color: #666; }

        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* æ‹†åˆ†æ¨¡å¼ç‰¹å®šæ¨£å¼ */
        #split-file-name {
            color: #28a745;
            font-weight: bold;
            margin-bottom: 10px;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>PDF å·¥å…·ç®±</h1>
    
    <!-- åˆ†é åˆ‡æ› -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('merge')">åˆä½µ / è½‰æª”</button>
        <button class="tab-btn" onclick="switchTab('split')">æ‹†åˆ† / æå–</button>
    </div>

    <!-- ================= åˆä½µæ¨¡å¼ (åŸæœ¬çš„åŠŸèƒ½) ================= -->
    <div id="merge-view" class="view-section active">
        <div class="input-group">
            <label for="mergeInput" class="custom-file-label">
                ğŸ“‚ é¸æ“‡åœ–ç‰‡æˆ– PDF æª”æ¡ˆ<br>
                <span style="font-size: 0.8rem; color: #999; font-weight: normal;">(æ”¯æ´å¤šæª”æ··åˆåˆä½µ)</span>
            </label>
            <input type="file" id="mergeInput" accept="image/*, .pdf" multiple onchange="handleMergeFiles(this.files)">
        </div>

        <div class="settings-group">
            <div class="setting-item">
                <label for="pageSize">ğŸ“„ åœ–ç‰‡é é¢å¤§å°ï¼š</label>
                <select id="pageSize">
                    <option value="original" selected>ä¾ç…§åœ–ç‰‡åŸå°ºå¯¸ (ç„¡ç•™ç™½)</option>
                    <option value="a4">A4 æ¨™æº–ç´™å¼µ (å¯èƒ½æœƒæœ‰ç™½é‚Š)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="quality">ğŸ—œï¸ åœ–ç‰‡å£“ç¸®å“è³ªï¼š</label>
                <select id="quality">
                    <option value="0.95" selected>é«˜ç•«è³ª (æª”æ¡ˆè¼ƒå¤§)</option>
                    <option value="0.75">æ¨™æº–å£“ç¸® (å»ºè­°ä½¿ç”¨)</option>
                    <option value="0.5">é«˜å£“ç¸® (æª”æ¡ˆæœ€å°)</option>
                    <option value="0.3">æ¥µé™å£“ç¸® (ç•«è³ªè¼ƒå·®)</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="showPageNumbers" style="cursor: pointer;">
                    ğŸ”¢ é¡¯ç¤ºé ç¢¼ (1/N)ï¼š
                </label>
                <input type="checkbox" id="showPageNumbers">
            </div>
        </div>

        <div id="preview-area"></div>

        <button id="convertBtn" class="action-btn" onclick="generateMergedPDF()">é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰</button>
        <div id="merge-status" class="status-msg"></div>
    </div>

    <!-- ================= æ‹†åˆ†æ¨¡å¼ (æ–°å¢çš„åŠŸèƒ½) ================= -->
    <div id="split-view" class="view-section">
        <div class="input-group">
            <label for="splitInput" class="custom-file-label">
                âœ‚ï¸ é¸æ“‡å–®å€‹ PDF æª”æ¡ˆ<br>
                <span style="font-size: 0.8rem; color: #999; font-weight: normal;">(ç”¨æ–¼æ‹†åˆ†æˆ–æå–é é¢)</span>
            </label>
            <input type="file" id="splitInput" accept=".pdf" onchange="handleSplitFile(this.files)">
        </div>
        
        <div id="split-file-name"></div>

        <div class="settings-group">
            <div class="setting-item">
                <label for="splitMode">âš™ï¸ æ‹†åˆ†æ¨¡å¼ï¼š</label>
                <select id="splitMode" onchange="updateSplitUI()">
                    <option value="all">æ‹†åˆ†æ¯ä¸€é  (ä¸‹è¼‰ ZIP å£“ç¸®åŒ…)</option>
                    <option value="range">æå–æŒ‡å®šé é¢ (ä¸‹è¼‰å–®ä¸€ PDF)</option>
                </select>
            </div>
            
            <div class="setting-item" id="rangeInputGroup" style="display: none;">
                <label for="pageRange">é ç¢¼ç¯„åœ (ä¾‹å¦‚: 1, 3-5, 8)ï¼š</label>
                <input type="text" id="pageRange" placeholder="è¼¸å…¥é ç¢¼ï¼Œå¦‚: 1-5, 8">
            </div>
        </div>

        <button id="splitBtn" class="action-btn" onclick="executeSplit()">åŸ·è¡Œæ‹†åˆ†</button>
        <div id="split-status" class="status-msg"></div>
    </div>
</div>

<script>
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    // å…¨åŸŸè®Šæ•¸å„²å­˜æ‹†åˆ†æ¨¡å¼çš„æª”æ¡ˆ
    let currentSplitFile = null;

    // --- Tab åˆ‡æ›é‚è¼¯ ---
    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));
        
        if (mode === 'merge') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('merge-view').classList.add('active');
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('split-view').classList.add('active');
        }
    }

    // ==========================================
    // 1. åˆä½µæ¨¡å¼é‚è¼¯ (Merge Mode)
    // ==========================================
    const previewArea = document.getElementById('preview-area');
    let dragSrcEl = null;

    function handleMergeFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => createPreviewItem(file));
        document.getElementById('mergeInput').value = '';
        updateOrderNumbers();
    }

    function createPreviewItem(file) {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.draggable = true;
        div.fileData = file;

        if (file.type === 'application/pdf') {
            const pdfIcon = document.createElement('div');
            pdfIcon.className = 'pdf-icon';
            pdfIcon.innerHTML = '<span>PDF</span>';
            div.appendChild(pdfIcon);
        } else {
            const img = document.createElement('img');
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; };
            reader.readAsDataURL(file);
            div.appendChild(img);
        }

        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.innerText = file.name;
        div.appendChild(fileName);

        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.innerHTML = 'Ã—';
        btn.onclick = function() { div.remove(); updateOrderNumbers(); };

        const pageNum = document.createElement('div');
        pageNum.className = 'page-number';
        pageNum.innerText = 'Item';

        div.appendChild(btn);
        div.appendChild(pageNum);
        addDragEvents(div);
        previewArea.appendChild(div);
    }

    function addDragEvents(item) {
        item.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        });
        item.addEventListener('dragover', function(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        });
        item.addEventListener('dragenter', function() { this.classList.add('over'); });
        item.addEventListener('dragleave', function() { this.classList.remove('over'); });
        item.addEventListener('drop', function(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                const items = Array.from(previewArea.children);
                if (items.indexOf(dragSrcEl) < items.indexOf(this)) { this.after(dragSrcEl); } 
                else { this.before(dragSrcEl); }
            }
            return false;
        });
        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            document.querySelectorAll('.preview-item').forEach(i => i.classList.remove('over'));
            updateOrderNumbers();
        });
    }

    function updateOrderNumbers() {
        document.querySelectorAll('.preview-item .page-number').forEach((item, index) => {
            item.innerText = `é †åº ${index + 1}`;
        });
    }

    async function generateMergedPDF() {
        const items = document.querySelectorAll('.preview-item');
        const status = document.getElementById('merge-status');
        const btn = document.getElementById('convertBtn');
        const pageSizeMode = document.getElementById('pageSize').value;
        const quality = parseFloat(document.getElementById('quality').value);
        const showPageNumbers = document.getElementById('showPageNumbers').checked;

        if (items.length === 0) { alert("è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹æª”æ¡ˆï¼"); return; }
        btn.disabled = true; btn.innerText = "è™•ç†ä¸­..."; status.innerText = "æº–å‚™åˆä½µ...";

        try {
            const pdfDoc = await PDFDocument.create();
            let font;
            if (showPageNumbers) font = await pdfDoc.embedFont(StandardFonts.Helvetica);

            for (let i = 0; i < items.length; i++) {
                const file = items[i].fileData;
                status.innerText = `æ­£åœ¨è™•ç†é …ç›® ${i + 1}/${items.length}...`;

                if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const srcPdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await pdfDoc.copyPages(srcPdf, srcPdf.getPageIndices());
                    copiedPages.forEach((page) => pdfDoc.addPage(page));
                } else {
                    const rawData = await readFileAsDataURL(file);
                    const imgObj = await loadImage(rawData);
                    const { buffer, width, height } = await convertToJpegBuffer(imgObj, quality);
                    const jpgImage = await pdfDoc.embedJpg(buffer);

                    let page;
                    if (pageSizeMode === 'original') {
                        page = pdfDoc.addPage([width, height]);
                        page.drawImage(jpgImage, { x: 0, y: 0, width, height });
                    } else {
                        const a4W = 595.28, a4H = 841.89, margin = 20;
                        page = pdfDoc.addPage([a4W, a4H]);
                        const dims = jpgImage.scaleToFit(a4W - margin*2, a4H - margin*2);
                        page.drawImage(jpgImage, { x: margin, y: a4H - margin - dims.height, width: dims.width, height: dims.height });
                    }
                }
            }

            if (showPageNumbers) {
                const pages = pdfDoc.getPages();
                pages.forEach((page, idx) => {
                    const text = `${idx + 1} / ${pages.length}`;
                    const size = 12;
                    const tw = font.widthOfTextAtSize(text, size);
                    const { width } = page.getSize();
                    page.drawRectangle({ x: (width/2)-(tw/2)-5, y: 15, width: tw+10, height: size+10, color: rgb(1,1,1), opacity: 0.8 });
                    page.drawText(text, { x: (width/2)-(tw/2), y: 22, size, font, color: rgb(0,0,0) });
                });
            }

            const pdfBytes = await pdfDoc.save();
            downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), 'merged-files.pdf');
            status.innerText = "åˆä½µå®Œæˆï¼";
        } catch (e) {
            console.error(e); alert("éŒ¯èª¤: " + e.message); status.innerText = "ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            btn.disabled = false; btn.innerText = "é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰";
        }
    }

    // ==========================================
    // 2. æ‹†åˆ†æ¨¡å¼é‚è¼¯ (Split Mode)
    // ==========================================
    function handleSplitFile(files) {
        if (!files.length) return;
        currentSplitFile = files[0];
        const nameDisplay = document.getElementById('split-file-name');
        nameDisplay.style.display = 'block';
        nameDisplay.innerText = `å·²é¸æ“‡æª”æ¡ˆ: ${currentSplitFile.name}`;
    }

    function updateSplitUI() {
        const mode = document.getElementById('splitMode').value;
        document.getElementById('rangeInputGroup').style.display = (mode === 'range') ? 'flex' : 'none';
    }

    async function executeSplit() {
        const status = document.getElementById('split-status');
        const btn = document.getElementById('splitBtn');
        const mode = document.getElementById('splitMode').value;

        if (!currentSplitFile) { alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ PDF æª”æ¡ˆï¼"); return; }
        
        btn.disabled = true; btn.innerText = "è™•ç†ä¸­..."; status.innerText = "è®€å– PDF ä¸­...";

        try {
            const arrayBuffer = await currentSplitFile.arrayBuffer();
            const srcPdf = await PDFDocument.load(arrayBuffer);
            const totalPages = srcPdf.getPageCount();

            if (mode === 'all') {
                // --- æ¨¡å¼A: æ‹†åˆ†æ‰€æœ‰é é¢ (ZIP) ---
                status.innerText = `æ­£åœ¨æ‹†åˆ† ${totalPages} é ï¼Œè«‹ç¨å€™...`;
                const zip = new JSZip();

                for (let i = 0; i < totalPages; i++) {
                    const newPdf = await PDFDocument.create();
                    const [copiedPage] = await newPdf.copyPages(srcPdf, [i]);
                    newPdf.addPage(copiedPage);
                    const pdfBytes = await newPdf.save();
                    
                    // æª”å: original_page_1.pdf
                    const name = currentSplitFile.name.replace('.pdf', '') + `_page_${i + 1}.pdf`;
                    zip.file(name, pdfBytes);
                }

                status.innerText = "æ­£åœ¨æ‰“åŒ… ZIP...";
                const zipContent = await zip.generateAsync({ type: "blob" });
                downloadBlob(zipContent, "split-pages.zip");
                status.innerText = "æ‹†åˆ†å®Œæˆï¼ZIP å·²ä¸‹è¼‰ã€‚";

            } else {
                // --- æ¨¡å¼B: æå–æŒ‡å®šç¯„åœ (PDF) ---
                const rangeStr = document.getElementById('pageRange').value;
                if (!rangeStr) { throw new Error("è«‹è¼¸å…¥é ç¢¼ç¯„åœ"); }

                const indicesToKeep = parsePageRange(rangeStr, totalPages);
                if (indicesToKeep.length === 0) { throw new Error("ç„¡æ•ˆçš„é ç¢¼ç¯„åœæˆ–é ç¢¼è¶…å‡ºç¯„åœ"); }

                const newPdf = await PDFDocument.create();
                const copiedPages = await newPdf.copyPages(srcPdf, indicesToKeep);
                copiedPages.forEach(page => newPdf.addPage(page));

                const pdfBytes = await newPdf.save();
                downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), "extracted-pages.pdf");
                status.innerText = `æå–å®Œæˆï¼å·²è¼¸å‡º ${indicesToKeep.length} é ã€‚`;
            }

        } catch (error) {
            console.error(error);
            alert("è™•ç†å¤±æ•—: " + error.message);
            status.innerText = "ç™¼ç”ŸéŒ¯èª¤";
        } finally {
            btn.disabled = false; btn.innerText = "åŸ·è¡Œæ‹†åˆ†";
        }
    }

    // è§£æé ç¢¼ (ä¾‹å¦‚ "1, 3-5" -> [0, 2, 3, 4])
    function parsePageRange(rangeStr, maxPages) {
        const pages = new Set();
        const parts = rangeStr.split(/[,ï¼Œ]/); // æ”¯æ´ä¸­è‹±æ–‡é€—è™Ÿ
        
        parts.forEach(part => {
            part = part.trim();
            if (part.includes('-')) {
                const [start, end] = part.split('-').map(Number);
                if (!isNaN(start) && !isNaN(end)) {
                    for (let i = start; i <= end; i++) pages.add(i);
                }
            } else {
                const p = parseInt(part);
                if (!isNaN(p)) pages.add(p);
            }
        });

        // è½‰ç‚º 0-based indexï¼Œéæ¿¾ç„¡æ•ˆé ç¢¼ï¼Œä¸¦æ’åº
        return Array.from(pages)
            .filter(p => p >= 1 && p <= maxPages)
            .map(p => p - 1)
            .sort((a, b) => a - b);
    }

    // ==========================================
    // 3. é€šç”¨è¼”åŠ©å‡½å¼
    // ==========================================
    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function loadImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = url;
        });
    }

    function convertToJpegBuffer(img, quality) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            canvas.toBlob((blob) => {
                const reader = new FileReader();
                reader.onload = () => resolve({ buffer: reader.result, width: img.width, height: img.height });
                reader.readAsArrayBuffer(blob);
            }, 'image/jpeg', quality);
        });
    }

    function downloadBlob(blob, fileName) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    }
</script>

</body>
</html>
